import subprocess
import sys
import os
import zipfile
import glob
import platform

# -----------------------------
# Paths
# -----------------------------
repo_root = os.path.abspath(os.path.dirname(__file__))
venv_dir = os.path.join(repo_root, "venv")

if platform.system() == "Windows":
    venv_python = os.path.join(venv_dir, "Scripts", "python.exe")
else:
    venv_python = os.path.join(venv_dir, "bin", "python")

# -----------------------------
# Create virtual environment
# -----------------------------
if not os.path.isdir(venv_dir):
    print("ğŸ Creating virtual environment...")
    subprocess.check_call([sys.executable, "-m", "venv", venv_dir])
else:
    print("âœ… Virtual environment already exists")

# -----------------------------
# Upgrade pip inside venv
# -----------------------------
print("âš¡ Upgrading pip in venv...")
subprocess.check_call([venv_python, "-m", "pip", "install", "--upgrade", "pip"])

# -----------------------------
# Install required packages
# -----------------------------
required_packages = [
    "pandas",
    "numpy",
    "scikit-learn",
    "matplotlib",
    "streamlit",
    "joblib",
]

print("ğŸ“¦ Installing dependencies into venv...")
subprocess.check_call([venv_python, "-m", "pip", "install", *required_packages])

# -----------------------------
# Add repo root to sys.path
# -----------------------------
if repo_root not in sys.path:
    sys.path.insert(0, repo_root)

# -----------------------------
# Extract data zip (if present)
# -----------------------------
data_dir = os.path.join(repo_root, "data")
preferred_zip = os.path.join(data_dir, "ORCHID_data.zip")
zip_candidates = glob.glob(os.path.join(data_dir, "*.zip"))

if os.path.isfile(preferred_zip):
    zip_path = preferred_zip
elif zip_candidates:
    zip_path = zip_candidates[0]
else:
    zip_path = None

if zip_path:
    extract_dir = os.path.join(
        data_dir, os.path.splitext(os.path.basename(zip_path))[0]
    )
    if not os.path.isdir(extract_dir):
        print(f"ğŸ“¦ Extracting data zip: {zip_path}")
        with zipfile.ZipFile(zip_path, "r") as zf:
            zf.extractall(extract_dir)
        print(f"âœ… Extracted to: {extract_dir}")
    else:
        print(f"âœ… Data already extracted: {extract_dir}")
else:
    print("âš ï¸ No data zip found in data/. Skipping extraction.")

# -----------------------------
# Train kidney models (using venv python)
# -----------------------------
print("ğŸ¯ Training left & right kidney models...")
subprocess.check_call([
    venv_python,
    os.path.join(repo_root, "models", "train_kidney_models.py")
])

print("\nğŸ‰ Setup complete!")
print("â¡ï¸ Activate the venv and run Streamlit:")
print("   source venv/bin/activate  (macOS/Linux)")
print("   venv\\Scripts\\activate   (Windows)")
print("ğŸ“Œ After activation, run:")
print("   streamlit run app/streamlit_app.py")
